#cover
  .g-wide-5-24.g-1-6
    != partial('_shared/haiiro_icon', { size: '30', color: '#e4e4e4', id: 'nav-icon' })
  .g-wide-19-24.g-10-12
  .g-wide-5-24.g-1-24
  .g-wide-14-24.g-11-12
    .myself
      .name
        a.paint(href= public._data.meta.profile_url, data-colors= '#999,#999,#999', target= '_blank')= public._data.meta.copyright
      .occupation= public._data.meta.occupation

nav#switcher
  .tab-wrapper
    .g-wide-5-24.g-1-6
    .g-wide-14-24.g-2-3
      .tabs
        a#planning-tab(href='#planning') Planning
        a#design-tab(href='#design') Design
    .g-wide-5-24.g-1-6

article#works
  - each tag in ['planning', 'design']
    - var filtered = public.works._data.filter(function (w) { return (w.tags.indexOf(tag) != -1); } );
    - eval(tag + '_works = filtered');

  section#planning-works.filtered-works
    each work in planning_works
      a.paint(href= '/works/' + work.name, data-colors= work.colors.join(','))
        .g-wide-6-24.g-1-24
        .g-wide-12-24.g-11-12
          .work
            .g-wide-3-4.g-7-8.title
              = work.title
            .g-wide-1-4.g-1-8.year
              = work.published_year
        .g-wide-5-24.g-1-24

  section#design-works.filtered-works
    .g-wide-2-24.g-1-24
    .g-wide-20-24.g-22-24
      each work in design_works
        .g-wide-1-3.g-1-1
          .work-image
            a.paint(href= '/works/' + work.name, data-colors= work.colors.join(','))
              img(src= '/images/works/' + work.name + '_1.jpg')
              .description
                p.title= work.title
                p.year= work.published_year

!= partial('_shared/footer')

script.
  (function() {
    var adjustScreenHeight = function() {
      var expandFooterHeight = window.innerHeight - u('nav#switcher').size().height - u('article#works').size().height - u('footer').size().height;
      var paddingFooter = expandFooterHeight > 50 ? expandFooterHeight : 50;
      u('footer').attr('style', 'margin-top: ' + paddingFooter + 'px;');
    };
    adjustScreenHeight();

    var resizeBanner = function() {
      var coverHeight = window.innerHeight * 0.80;
      u('#cover').attr('style', 'height: ' + coverHeight + 'px;')
      u('body').attr('style', 'min-height: ' + coverHeight * 2 + 'px;');
      var nameMargin = (u('#cover').size().height - u('.myself').size().height) / 2 - u('svg.haiiro-icon').parent().size().height;
      u('.myself').attr('style', 'margin-top: ' + nameMargin + 'px;');
    };
    window.onresize = function() {
      if (window.innerWidth < 768) return;
      resizeBanner();
    }

    resizeBanner();
    var handleHeader = function() {
      var scrolled = window.scrollY;
      if (scrolled > 0) {
        u('#nav-icon').data('colors', ["#ccc", "#ccc", "#ccc"].join(','));
      } else {
        u('#nav-icon').data('colors', "#{public._data.meta.profile_colors.join(',')}");
      }

      if (scrolled > u('#cover').size().height) {
        u('#switcher > .tab-wrapper').addClass('sticked');
      } else {
        u('#switcher > .tab-wrapper').removeClass('sticked');
      }

      if (scrolled > u('#cover').size().height - 90) {
        var rest = u('#cover').size().height - scrolled
        if (rest < 0) rest = 0;
        var w = 186 - 93 * rest / 90;
        var h = 180 - 90 * rest / 90;
        var t = 10 +  10 * rest / 90;

        u('#nav-icon').attr('style', 'top: ' + t + 'px');
        u('#nav-icon').attr('viewBox', '0 0 ' + w + ' ' + h);
      } else {
        u('#nav-icon').attr('style', 'top: 20px');
        u('#nav-icon').attr('viewBox', '0 0 93 90');
      }
    }

    var plannings = u('#planning-tab, section#planning-works');
    var designs = u('#design-tab, section#design-works');
    var switchWorks = function(target) {
      (target == 'planning' ? plannings : designs).addClass('active');
      (target == 'planning' ? designs : plannings).removeClass('active');
      adjustScreenHeight();
    };
    u('.tabs > a').on('click', function(e) {
      target = u(this).attr('id').replace('-tab', '')
      switchWorks(target);
      window.location.hash = target;
      e.preventDefault();
    });
    switchWorks(window.location.hash == '#design' ? 'design' : 'planning');

    var scrollTo = function(target) {
      setTimeout(function() {
        var direction = u(target).nodes[0].offsetTop < document.body.scrollTop ? -1 : 1;
        if (Math.abs(u(target).nodes[0].offsetTop - document.body.scrollTop) < 8) {
          u(target).scroll();
        } else {
          document.body.scrollTop = document.body.scrollTop + 10 * direction;
          scrollTo(target);
        }
      }, 5);
    };
    u('#planning-tab, #design-tab').on('click', function() {
      // https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView#Browser_compatibility
      // u('#switcher').scroll();
      scrollTo('#switcher');
    });
    u('#nav-icon').on('click', function(e) {
      if (window.scrollY > 0) {
        scrollTo('#cover');
      } else {
        u('.myself > .name > a').trigger('click');
      }
    });

    var hookPaintings = u('a.paint, svg.haiiro-icon#nav-icon');
    var rects = u('svg.haiiro-icon#nav-icon > rect');
    hookPaintings.on('mouseover', function(e) {
      var colors = u(this).data('colors').split(',');
      var pallet = [];
      for (i = 0; i < rects.length; i++) {
        pallet.push(colors.length > i ? colors[i] : (colors[i - colors.length] ? colors[i - colors.length] : colors[1]));
      }
      paintHaiiro(rects, pallet);
    });
    var paintHaiiro = function(rects, colors) {
      if (colors.length != 7) return;
      for (i = 0; i < rects.length; i++) { u(rects.nodes[i]).attr('fill', colors[i]); }
    }
    var defaultColors = ['#d4d4d4', '#a7a7a7', '#cfcfcf', '#d7d7d7', '#cdcdcd', '#c7c7c7', '#d1d1d1'];
    hookPaintings.on('mouseleave', function(e) {
      paintHaiiro(rects, defaultColors);
    });

    // for mobile browser
    if(!!('ontouchstart' in window)) {
      hookPaintings.off('mouseover mouseleave');

      // the workaround for iOS which doesn't trigger scroll event while touching screen
      var watchScroll = function() {
        setTimeout(function() {
          handleHeader();
          watchScroll();
        }, 300);
      };
      watchScroll();
    }
    paintHaiiro(rects, defaultColors);

    window.addEventListener('scroll', function(e) { handleHeader(); });
  })();
