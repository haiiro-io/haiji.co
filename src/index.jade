#nav-bar
  .g-wide-5-24.g-1-6.icon
    != partial('_shared/haiiro_icon', { size: '15', color: '#e0559f', id: 'nav-icon' })
  .g-wide-14-24.g-2-3
    .tabs
      a#planning-tab-header(href='#planning') Planning
      a#design-tab-header(href='#design') Design
  .g-wide-5-24.g-1-6

#cover
  .g-wide-5-24.g-1-6
    != partial('_shared/haiiro_icon', { size: '30', color: '#e4e4e4', id: 'top-icon' })
  .g-wide-19-24.g-10-12
  .g-wide-5-24.g-1-24
  .g-wide-14-24.g-11-12
    .myself
      .name= public._data.meta.copyright
      .occupation= public._data.meta.occupation

#switcher
  .tabs.show
    a#planning-tab(href='#planning') Planning
    a#design-tab(href='#design') Design

#works
  - each tag in ['planning', 'design']
    - var filtered = public.works._data.filter(function (w) { return (w.tags.indexOf(tag) != -1); } );
    - eval(tag + '_works = filtered');

  #planning-works.filtered-works
    each work in planning_works
      a(href= '/works/' + work.name, data-colors= work.colors.join(','))
        .g-wide-6-24.g-1-24
        .g-wide-12-24.g-11-12
          .work
            .g-wide-3-4.g-7-8.title
              = work.title
            .g-wide-1-4.g-1-8.year
              = work.published_year
        .g-wide-5-24.g-1-24

  .g-wide-2-24.g-1-24
  .g-wide-20-24.g-22-24
    #design-works.filtered-works
      each work in design_works
        .g-wide-1-3.g-1-1
          .work-image
            a(href= '/works/' + work.name, data-colors= work.colors.join(','))
              img(src= '/images/works/' + work.name + '_1.jpg')
              .description
                p.title= work.title
                p.year= work.published_year

!= partial('_shared/footer')

script.
  (function() {
    // FIXME
    u('#footer').addClass('show');

    var adjustScreenHeight = function() {
      var expandFooterHeight = window.innerHeight - u('#nav-bar').size().height - u('#works').size().height - u('#footer').size().height;
      u('#footer').attr('style', 'margin-top: ' + expandFooterHeight + 'px;');
    };

    var plannings = u('#planning-tab, #planning-works, #planning-tab-header');
    var designs = u('#design-tab, #design-works, #design-tab-header');
    var switchWorks = function(target) {
      (target == 'planning' ? plannings : designs).addClass('active');
      (target == 'planning' ? designs : plannings).removeClass('active');
      adjustScreenHeight();
    };
    u('.tabs > a').on('click', function(e) {
      target = u(this).attr('id').replace('-tab-header', '').replace('-tab', '')
      switchWorks(target);
      window.location.hash = target;
      e.preventDefault();
    });
    switchWorks(window.location.hash == '#design' ? 'design' : 'planning');

    var scrollTo = function(target) {
      setTimeout(function() {
        var direction = u(target).nodes[0].offsetTop < document.body.scrollTop ? -1 : 1;
        if (Math.abs(u(target).nodes[0].offsetTop - document.body.scrollTop) < 8) {
          u(target).scroll();
        } else {
          document.body.scrollTop = document.body.scrollTop + 10 * direction;
          scrollTo(target);
        }
      }, 5);
    };
    u('#planning-tab, #design-tab, #planning-tab-header, #design-tab-header').on('click', function() {
      // https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView#Browser_compatibility
      // u('#switcher').scroll();
      scrollTo('#switcher');
    });

    var rects = u('svg.haiiro-icon#nav-icon > rect');
    u('#planning-works a, #design-works a').on('mouseover', function(e) {
      var colors = u(this).data('colors').split(',');
      var pallet = [];
      for (i = 0; i < rects.length; i++) {
        pallet.push(colors.length > i ? colors[i] : (colors[i - colors.length] ? colors[i - colors.length] : colors[1]));
      }
      paintHaiiro(rects, pallet);
    });
    var paintHaiiro = function(rects, colors) {
      if (colors.length != 7) return;
      for (i = 0; i < rects.length; i++) { u(rects.nodes[i]).attr('fill', colors[i]); }
    }
    var defaultColors = ['#d4d4d4', '#a7a7a7', '#cfcfcf', '#d7d7d7', '#cdcdcd', '#c7c7c7', '#d1d1d1'];
    u('#works a').on('mouseleave', function(e) {
      paintHaiiro(rects, defaultColors);
    });
    if(!!('ontouchstart' in window)) { u('#planning-works a, #design-works a').off('mouseover mouseleave'); }
    paintHaiiro(rects, defaultColors);
    paintHaiiro(u('svg.haiiro-icon#top-icon > rect'), defaultColors);

    var resizeBanner = function() {
      var coverHeight = window.innerHeight * 0.80;
      u('#cover').attr('style', 'height: ' + coverHeight + 'px;')
      u('body').attr('style', 'min-height: ' + coverHeight * 2 + 'px;');
      var nameMargin = (u('#cover').size().height - u('.myself').size().height) / 2 - u('svg.haiiro-icon').parent().size().height;
      u('.myself').attr('style', 'margin-top: ' + nameMargin + 'px;');
      adjustScreenHeight();
    };
    window.onresize = function() {
      if (window.innerWidth < 768) return;
      resizeBanner();
    }
    resizeBanner();

    window.addEventListener('scroll', function(e) {
      if (window.scrollY > 100) {
        u('#nav-bar').addClass('show');
        u('#switcher > .tabs').removeClass('show');
      } else {
        u('#nav-bar').removeClass('show');
        u('#switcher > .tabs').addClass('show');
      }
    });
  })();
